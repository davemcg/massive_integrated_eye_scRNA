```{r, fig.width=15, fig.height=15}
library(tidyverse)
library(Seurat)
library(scattermore)
library(scran)
library(slingshot)
library(ComplexHeatmap)
library(ggraph)
library(tidygraph)
#load('~/data/massive_integrated_eye_scRNA/sling_trajectory.Rdata')
#load('/Volumes/data/projects/nei/mcgaughey/scEiaD_me/site_make/sling_mus.Rdata')
load('~/data/massive_integrated_eye_scRNA/Mus_musculus_Macaca_fascicularis_Homo_sapiens__n_spec_genes-0__n_features2000__counts__TabulaDroplet__batch__scVI__dims8__preFilter__mindist0.001__nneighbors500__knn0.6__trajHomo_sapiens.Rdata')
load('~/data/massive_integrated_eye_scRNA/diffPT_sling_HS.Rdata')
gene_id_converter <- read_tsv('~/data/massive_integrated_eye_scRNA/ensembl_biomart_human2mouse_macaque.tsv', skip = 1,
                              col_names= c('hs_gene_id','hs_gene_id_v', 'mm_gene_id', 'mf_gene_id',
                                           'hs_gene_name', 'mf_gene_name', 'mm_gene_name')) %>%
  select(-hs_gene_id_v)
tf <- readxl::read_xlsx('~/git/massive_integrated_eye_scRNA/data/1-s2.0-S0092867418301065-mmc2.xlsx', skip = 1, sheet = 'Table S1. Related to Figure 1B')
```


```{r}

lin <- sling$lineage

node_pos <- umap_cut %>%
  group_by(seurat_cluster_CT) %>% 
  summarise(x=mean(UMAP_1), y = mean(UMAP_2)) %>% 
  rename(name = seurat_cluster_CT)
xy = colnames(lin@adjacency) %>% 
  enframe(name = 'row', value = 'name') %>% 
  left_join(node_pos) %>% select(name, x,y) %>% 
  #filter(name %in% lin@lineages[[1]]) %>% 
  select(-name)

create_layout(as_tbl_graph(lin@adjacency), #%>% 
              #filter(name %in% lin@lineages[[1]]),
              'manual', 
              x=xy$x, 
              y=xy$y)  %>% 
  ggraph() + 
  geom_edge_link() +
  geom_scattermore(data = umap, aes(x=UMAP_1, y=UMAP_2, color = CellType_predict)) + geom_edge_link(color = 'yellow') + geom_node_point(color = 'yellow', size = 3) + scale_color_manual(values = c(pals::alphabet2(), pals::alphabet()) %>% unname()) + cowplot::theme_cowplot()
```
```{r, fig.width=15, fig.height=15}
umap %>% mutate(CellType_predict = case_when(is.na(CellType_predict) ~ 'Unlabelled',
                                             TRUE ~ CellType_predict)) %>% 
  mutate(CellType_predict = case_when(is.na(CellType_predict) ~ 'Unknown', TRUE ~ CellType_predict)) %>% 
  ggplot(aes(x=UMAP_1, y=UMAP_2, color = CellType_predict)) + 
  geom_scattermore(pointsize =  1, pixels = c(1000,1000), alpha = 0.2) + 
  scale_color_manual(values = c(pals::alphabet2(), pals::alphabet()) %>% unname()) + 
  cowplot::theme_cowplot() +
  guides(color = guide_legend(override.aes = list(size = 3, alpha = 1) ) )
```

```{r, fig.width=15, fig.height=5}
umap  %>% ggplot(aes(x=UMAP_1, y=UMAP_2, color = Platform)) + geom_scattermore(size = 5, pixels = c(1000,1000)) + scale_color_manual(values = c(pals::alphabet()) %>% unname()) + cowplot::theme_cowplot() + facet_wrap(~Platform)
umap  %>% ggplot(aes(x=UMAP_1, y=UMAP_2, color = CellType_predict)) + geom_scattermore(size = 5, pixels = c(1000,1000)) + scale_color_manual(values = c(pals::alphabet(), pals::alphabet2()) %>% unname()) + cowplot::theme_cowplot() + facet_wrap(~organism)
```

```{r, fig.width=15, fig.height=15}
embedded <- sling$embedded
path <- list()
for (i in seq(1:(embedded@lineages %>% length()))){
  embedded_i = slingCurves(embedded)[[i]]
  path[[i]] = data.frame(embedded_i$s[embedded_i$ord,])
  path[[i]]$curve <- i
}
psTime <- slingshot::slingPseudotime(sling$sling )

psTime %>% 
  as_tibble(rownames = 'Barcode') %>% 
  pivot_longer(contains('curve'), names_to = 'Curve', values_to = 'Pseudotime') %>% 
  filter(!is.na(Pseudotime)) %>% 
  left_join(umap) %>% 
  mutate(curve = str_extract(Curve, '\\d+') %>% as.integer()) %>% 
  ggplot(aes(x=UMAP_1, y = UMAP_2, colour = Pseudotime)) + 
  facet_wrap(~curve) + 
  geom_scattermore(data = umap, aes(x=UMAP_1, y = UMAP_2), color = 'gray', pointsize = 0.1, alpha = 0.4) + 
  geom_scattermore(pointsize = 1, alpha = 0.4) + 
  cowplot::theme_cowplot() + 
  scale_color_viridis_c() + 
  xlab('UMAP 1') + ylab('UMAP 2') +
  facet_wrap(~curve) + 
  geom_path(data = path %>% bind_rows(), aes(x=UMAP_1, y = UMAP_2), color = 'red', size = 1) 

```


# Labelled 
```{r, fig.width=15, fig.height=25}
ct_proportion <- umap %>% group_by(CellType_predict) %>% summarise(CT_Count = n()) %>% mutate(CT_Proportion = CT_Count/sum(CT_Count) * 100)

celltype_pseudotime <- psTime %>% 
  as_tibble(rownames = 'Barcode') %>% 
  pivot_longer(contains('curve'), names_to = 'Curve', values_to = 'Pseudotime') %>% 
  filter(!is.na(Pseudotime)) %>% 
  left_join(umap_cut) %>% 
  filter(!is.na(CellType_predict)) %>% 
  group_by(Curve, CellType_predict) %>% 
  summarise(Count = n(), 
            Pseudotime = median(Pseudotime, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(Curve) %>% 
  mutate(Proportion  = Count / sum(Count) * 100) %>% 
  left_join(ct_proportion, by = 'CellType_predict') %>% 
  mutate(Enrichment = Proportion/CT_Proportion) %>% 
  filter(Enrichment > 0.6) %>% 
  mutate(Curve = str_extract(Curve, '\\d+') %>% as.integer()) %>% arrange(Curve, Pseudotime) %>% data.frame()

psTime_data <- psTime %>% 
  as_tibble(rownames = 'Barcode') %>% 
  pivot_longer(contains('curve'), names_to = 'Curve', values_to = 'Pseudotime') %>% 
  filter(!is.na(Pseudotime)) %>% 
  left_join(umap) %>% 
  #mutate(CellType = gsub('\\d+: ','', seurat_cluster_CT)) %>% 
  mutate(Curve = str_extract(Curve, '\\d+') %>% 
           as.numeric()) %>% filter(!is.na(Pseudotime), 
                                    CellType_predict != 'Endothelial')

psTime_data$Curve <- psTime_data$Curve + runif(nrow(psTime_data), -0.2, 0.2)

psTime_data %>% 
  ggplot(aes(x=Pseudotime, color = `CellType_predict`, y = Curve)) + 
  geom_scattermore(alpha = 0.1, pointsize = 0) + 
  scale_color_manual(values = c(pals::alphabet2(), pals::alphabet()) %>% 
                       unname()) + 
  ggrepel::geom_label_repel(data = celltype_pseudotime, 
                            aes(label = CellType_predict), color = 'black') +
  cowplot::theme_cowplot()
```


```{r}
celltype_pseudotime %>% arrange(Curve, Pseudotime) %>% data.frame()

sling$lineage
```

#Curve 3
```{r}
pt <- psTime %>% 
  as_tibble(rownames = 'Barcode') %>% 
  pivot_longer(contains('curve'), names_to = 'Curve', values_to = 'Pseudotime') %>% 
  filter(!is.na(Pseudotime)) %>% filter(Curve == 'curve3') 

genes <- c('ENSG00000129535', 'ENSG00000163914', 'ENSG00000007372', 'ENSG00000196230', 'ENSG00000110492')
#genes <- c('ENSG00000060138')
if (length(genes) == 1){
  cts <- logcounts(sling$sling)[c(genes),pt$Barcode] %>% enframe(name = 'Barcode', value = 'Counts') %>% mutate(Gene = genes)
} else {
  cts <- logcounts(sling$sling)[c(genes),pt$Barcode] %>% t() %>% as_tibble(rownames = 'Barcode') %>% pivot_longer(-Barcode, names_to = 'Gene', values_to = 'Counts')
}

pt %>% left_join(cts) %>% ggplot(aes(x=Pseudotime, y = Counts, color = Gene)) + geom_smooth()
```

```{r, fig.height=5, fig.width=10}

hm_maker <- function(pseudotime, num_of_genes = 10, onlyShowTF = FALSE, genes = NULL){
  if (is.null(genes)){
    genes <- diffPT[[pseudotime]] %>% 
      as_tibble(rownames = 'Gene') %>% 
      arrange(FDR,-abs(logFC)) %>% 
      head(num_of_genes) %>% 
      pull(Gene)
    if (onlyShowTF){
      genes <- diffPT[[pseudotime]] %>% 
        as_tibble(rownames = 'Gene') %>% 
        arrange(FDR,-abs(logFC)) %>% 
        filter(Gene %in% tf$ID) %>% 
        head(num_of_genes) %>% 
        pull(Gene)
    }
  }
  pseudoT <- pseudotime
  bc_data <- colData(sling$sling) %>% 
    as_tibble(rownames = 'Barcode') %>% 
    select(Barcode, one_of(pseudoT)) 
  names(bc_data)[2] <- 'PT'
  bc_time <- bc_data %>% 
    filter(!is.na(PT)) %>% 
    arrange(PT) %>% select(Barcode, PT)
  bc <- bc_time %>% pull(Barcode)
  pt <- bc_time %>% pull(PT)
  ct <- umap %>% right_join(bc %>% enframe(value = 'Barcode')) %>% pull(CellType_predict)
  
  mat <- logcounts(sling$sling)[genes, bc]
  
  long <- mat %>% t() %>% as_tibble(rownames = 'Barcode')  %>% 
    left_join(umap %>% right_join(bc_time)) %>% 
    select(PT, contains('ENSG'), CellType_predict, organism)
  
  #long$order <- 1:nrow(long)
  long$group <- ceiling(long$PT / 0.05)
  long <- long %>%  right_join(seq(min(long$group),max(long$group)) %>% enframe(value = 'group') )
  new_colname <- long  %>% 
    select(CellType_predict, group) %>% 
    group_by(group, CellType_predict) %>% 
    summarise(count = n()) %>% 
    top_n(1, count) %>% 
    mutate(id = paste0(group, '__', CellType_predict))
  org <- long  %>% 
    select(organism, group) %>% 
    group_by(group, organism) %>% 
    summarise(count = n()) %>% 
    top_n(1, count)
  new_colname <- left_join(new_colname, org, by = 'group') %>% 
    mutate(id = paste0(id, '__', organism))
  
  mat_smooth <- long %>% select(contains("ENSG"), group) %>% group_by(group) %>% summarise_all(mean) %>% left_join(new_colname) %>% select(contains('ENS'), id) 
  
  id <- mat_smooth$id 
  mat_smooth <- mat_smooth %>% select(-id) %>% t()
  id <- gsub('NA','Unlabelled',id)
  
  # set colors
  ct_p_colors <- c(pals::alphabet2(), pals::alphabet())
  ct_p_colors <- ct_p_colors[1:(umap$CellType_predict %>% unique() %>% sort() %>% length())]
  names(ct_p_colors) <- umap$CellType_predict %>% unique() %>% sort()
  ct_p_colors <- c('white', ct_p_colors)
  names(ct_p_colors)[1] <- 'Unlabelled'
  #ct_p_colors_list <- split(unname(ct_p_colors),names(ct_p_colors))
  ha_column = HeatmapAnnotation(df = data.frame(CellType = str_split(id, '__') %>% map(2) %>% unlist() ,
                                                Organism = str_split(id, '__') %>% map(3) %>% unlist()),
                                col = list(CellType = ct_p_colors,
                                           Organism = c('Homo sapiens' = 'orange',
                                                        'Mus musculus' = 'green',
                                                        'Macaca fascicularis' = 'blue',
                                                        'Unlabelled' = 'white'))
  )
  # label as TF or not
  gene_type <- row.names(mat_smooth) %in% tf$ID
  gene_type <- gsub(FALSE, 'No', gene_type)
  gene_type <- gsub(TRUE, 'Yes', gene_type)
  gene_type_col = list('Yes' = 'black', 'No' = 'white')
  # replace ENS with ID
  row.names(mat_smooth) <- 
    row.names(mat_smooth) %>% 
    enframe(value = 'hs_gene_id') %>% 
    left_join(gene_id_converter %>% 
                select(hs_gene_id, hs_gene_name) %>% unique()) %>% 
    pull(hs_gene_name)
  # make heatmap
  hm <- Heatmap(mat_smooth,
                cluster_columns = FALSE, 
                cluster_rows = TRUE, 
                show_column_names = FALSE,
                col=viridis::viridis(100),
                top_annotation = ha_column,
                name = 'log Counts')
  gene_col <- Heatmap(gene_type, name = "TF", col = gene_type_col)
  if (onlyShowTF){
    hm
  } else {
    draw(hm + gene_col, auto_adjust = FALSE)
  }
}

tf_plots <- list()
for (i in colData( sling$sling) %>% colnames() %>% grep('slingP',.,value = TRUE)){
  tf_plots[[i]] <- try({hm_maker(i, 10, onlyShowTF = TRUE)})
}

gene_plots <- list()
for (i in colData( sling$sling) %>% colnames() %>% grep('slingP',.,value = TRUE)){
  gene_plots[[i]] <- try({hm_maker(i, 40, onlyShowTF = FALSE)})
}


hm_maker('slingPseudotime_1', 10, onlyShowTF = TRUE, genes = c('ENSG00000134438','ENSG00000114315', 'ENSG00000148400'))
hm_maker('slingPseudotime_11', 30) 
```

# set of TF
```{r}
diffPT_tibble <- list()
for (i in names(diffPT)){
  diffPT_tibble[[i]] <- diffPT[[i]] %>% as_tibble(rownames = 'Gene') %>% select(Gene:FDR)
}
diffPT_tibble <- diffPT_tibble %>% bind_rows(.id = 'Trajectory')
diffPT_tibble %>% left_join(gene_id_converter %>% select(Gene = hs_gene_id, hs_gene_name)) %>% 
  filter(FDR == 0, Gene %in% tf$ID) %>% group_by(Trajectory) %>% top_n(40, abs(logFC)) %>% 
  group_by(hs_gene_name) %>% summarise(Count = n(), abs_logFC = mean(abs(logFC))) %>% arrange(-abs_logFC)

```


```{r}
library(tidymodels)
library(rsample)
pseudoT <- 'slingPseudotime_1'
pt1_tf <- diffPT_tibble %>% filter(Trajectory == pseudoT) %>% left_join(gene_id_converter %>% select(Gene = hs_gene_id, hs_gene_name)) %>% filter(FDR == 0, Gene %in% tf$ID) %>% unique() %>% arrange(-abs(logFC)) %>% pull(Gene)

bc_data <- colData(sling$sling) %>% 
  as_tibble(rownames = 'Barcode') %>% 
  select(Barcode, one_of(pseudoT)) 
names(bc_data)[2] <- 'PT'
bc_time <- bc_data %>% 
  filter(!is.na(PT)) %>% 
  arrange(PT) %>% select(Barcode, PT)

mat <- logcounts(sling$sling)[pt1_tf, bc_time$Barcode]
tidyPT <- mat %>% t() %>% as_tibble(rownames = 'Barcode')  %>% 
  left_join(umap %>% right_join(bc_time)) %>% 
  select(PT, contains('ENSG'), CellType_predict, organism) %>% pivot_longer(-c(PT, CellType_predict, organism), names_to = 'Gene', values_to = 'CPM')

# ggplot(tidyPT %>% sample_frac(0.1),
#        aes(x = PT, 
#            y = CPM, 
#            group = Gene, 
#            col = Gene)) + 
#   geom_point() + 
#   geom_smooth(method = lm, se = FALSE) +
#   scale_color_viridis_d(option = "plasma", end = .7)

set.seed(555)
# Put 1/4 of the data into the training set 
# 
data_split <- initial_split(tidyPT, prop = 1/4)

# Create data frames for the two sets:
train_data <- training(data_split)
test_data  <- testing(data_split)

lm_mod <- 
  linear_reg() %>% 
  set_engine("lm")
lm_fit <- 
  lm_mod %>% 
  fit(PT ~ CPM * Gene, data = train_data)
lm_fit2 <- 
  lm_mod %>% 
  fit(PT ~ CPM + Gene, data = train_data)
lm_fit3 <- 
  lm_mod %>% 
  fit(PT ~ CPM:Gene, data = train_data)
lm_fit

```
